<html>
<head>
    <title>Login Workflow</title>
    <style>
        body { 
            background: #EB5424;
        }
        pre {
            word-wrap: break-word;
            padding: 2em;
        }
    </style>
</head>
<body hidden>
    <h1>Web Task Samples: Login Workflow</h1>
    <p>Executing 3 step login workflow using web tasks:</p>
    <il>
        <li>[app] Start workflow from originating app</a>
        <li>[webtasks] Login with Google</li>
        <li>[webtasks] Then login with Microsoft</li>
        <li>[webtasks] Then accept privacy policy</li>
        <li>[app] Then return to originating app</li>
    </il>
    <p><strong>NOTE</strong> originating app has orange background, webtask workflow has blue background.<p>
    <form id="auth0-wf" method="POST">
        <input type="submit" value="Start login workflow"/>
    </form>
    <pre id="results"></pre>

    <script>
        // Webtask Workflow is a state machine. Each state describes:
        // * url - the webtask to run in that state
        // * inputs - client-side data to pass to the webtask
        // * next - a string describing the next state to transition to after the webtask 
        //   is done, or a function that returns the next state to transition to
        // * transition - 'manual' or 'auto' (default); whether the invocation of the next 
        //   webtask state is done automatically or requires app/user initiatied action
        //   (e.g. click of a form submit or programmatic submit)
        // The `start` state is the default initial state unless overriden in a call to 
        // resume_workflow. The `end` state is the final state.
        // Other state names are application specific. 
        var workflow = {
            google: {

                // Login with Google

                url: 'https://sandbox.it.auth0.com/auth0-wf?webtask_no_cache=1&key=eyJhbGciOiJIUzI1NiIsImtpZCI6IjEifQ.eyJqdGkiOiI5YjFjMGNlNjgyZTQ0NzlhODY1ZTE2Y2JlYjdjNzVmZiIsImlhdCI6MTQyNTY3Nzc4MywidXJsIjoiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2F1dGgwL3dlYnRhc2stc2NyaXB0cy9tYXN0ZXIvbG9naW4vYXV0aDBfbG9naW4uanMiLCJ0ZW4iOiJhdXRoMC13ZiIsInBjdHgiOnsiYXV0aDBfZG9tYWluIjoiYXV0aDAtd2YuYXV0aDAuY29tIiwiYXV0aDBfY2xpZW50X2lkIjoiZ2RVOG50NVFiZE1BcGM4N2VkN2UxQlRlWTQ2TzdDemMifX0.MvwWuM__Y_z8WRUL4QnSA9foxL__eq2l6Q3ywcwzkmw',
                inputs: {
                    strategy: 'google-oauth2',
                    title: 'Please authenticate with Google first'
                },
                transition: 'manual',
                next: 'microsoft'
            },
            microsoft: {

                // Login with Microsoft

                url: 'https://sandbox.it.auth0.com/auth0-wf?webtask_no_cache=1&key=eyJhbGciOiJIUzI1NiIsImtpZCI6IjEifQ.eyJqdGkiOiI5YjFjMGNlNjgyZTQ0NzlhODY1ZTE2Y2JlYjdjNzVmZiIsImlhdCI6MTQyNTY3Nzc4MywidXJsIjoiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2F1dGgwL3dlYnRhc2stc2NyaXB0cy9tYXN0ZXIvbG9naW4vYXV0aDBfbG9naW4uanMiLCJ0ZW4iOiJhdXRoMC13ZiIsInBjdHgiOnsiYXV0aDBfZG9tYWluIjoiYXV0aDAtd2YuYXV0aDAuY29tIiwiYXV0aDBfY2xpZW50X2lkIjoiZ2RVOG50NVFiZE1BcGM4N2VkN2UxQlRlWTQ2TzdDemMifX0.MvwWuM__Y_z8WRUL4QnSA9foxL__eq2l6Q3ywcwzkmw',
                inputs: {
                    strategy: 'windowslive',
                    title: 'Now authenticate with Microsoft Account'
                },
                next: 'end'
            }
        }

        // Resume workflow 
        if (!resume_workflow(workflow, { intitial_state: 'google' })) {
            // Workflow completed, do something smart with the results
            document.getElementById('results').innerHTML = 'Workflow completed. Here are results of all workflow steps:\n\n' 
                + JSON.stringify(get_workflow_state(), null, 2);
            document.forms['auth0-wf'].style.display = 'none';
        }

        // Workflow orchestration engine would ship as a client side library. 
        // Right now it is implemented in place below.

        function get_workflow_state(storage_key) {
            storage_key = storage_key || 'auth0_result';
            var result = localStorage.getItem(storage_key);
            if (result)
                return JSON.parse(result);
            else
                return {};
        }

        function resume_workflow(workflow, options) {
            if (!workflow || typeof workflow !== 'object')
                throw new Error('options.workflow parameter must be specified.')
            if (options && typeof options !== 'object')
                throw new Error('options parameter must be an object.')

            options = options || {};
            options.storage_key = options.storage_key || 'auth0_result';
            options.intitial_state = options.intitial_state || 'start';

            // Determine current workflow state
            var hash = getHashParams();
            var state = hash.state;
            delete hash.state;

            // Update workflow results in local storage
            var auth0_result;
            if (state !== null && state !== undefined) {
                
                auth0_result = localStorage.getItem(options.storage_key);
                if (auth0_result)
                    auth0_result = JSON.parse(auth0_result);
                auth0_result[state] = hash;
            }
            else {
                auth0_result = {};
            }
            localStorage.setItem(options.storage_key, JSON.stringify(auth0_result));

            // store workflow data in local storage

            // Determine state transition
            var nextState;
            if (state === null || state === undefined) {
                nextState = options.intitial_state;
            }
            else if (!workflow[state]) {
                throw new Error("Workflow does not define state `" + state + "`.");
            }
            else if (typeof workflow[state].next === 'undefined' || workflow[state].next === 'end') {
                nextState = null;
            }
            else if (typeof workflow[state].next === 'string') {
                nextState = workflow[state].next;
            }
            else if (typeof workflow[state].next === 'function') {
                nextState = workflow[state].next(options);
            }
            else {
                throw new Error("The `next` property of state `" + state + "` must be a string or a function returning a string.");
            }

            if (nextState === null) {
                // Workflow completed
                document.body.removeAttribute('hidden');
                return false;
            }
            else if (!workflow[nextState] || typeof workflow[nextState] !== 'object') {
                throw new Error("Workflow does not define state `" + nextState + "`, unable to transition.");
            }
            else if (typeof workflow[nextState].url !== 'string') {
                throw new Error("Workflow state `" + nextState + "` does not define `url` property, unable to transition.");
            }
            else {
                // Set up the form for a POST that will initiate the next webtask to run
                options.form_id = options.form_id || 'auth0-wf';
                var form = document.forms[options.form_id];
                if (!form) {
                    throw new Error("The page does not contain form with id `" + options.form_id + "`. Unable to set up workflow state transition.");
                }
                form.method = 'POST';
                form.action = workflow[nextState].url;
                addHidden(form, 'callback', workflow[nextState].callback || 
                    (window.location.origin 
                        + window.location.pathname 
                        + window.location.search);
                addHidden(form, 'state', nextState);
                if (workflow[nextState].inputs && typeof workflow[nextState].inputs === 'object') {
                    for (var i in workflow[nextState].inputs) {
                        addHidden(form, i, workflow[nextState].inputs[i]);
                    }
                }
                if (workflow[nextState].transition === 'auto' || workflow[nextState].transition === undefined) {
                    // Automatically submit the form
                    form.submit();
                }
                else if (workflow[nextState].transition !== 'manual') {
                    throw new Error("Workflow state `" + nextState + "` has an unsupported value of the `transition` property. Only `manual` or `auto` are supported.");
                }
                else {
                    // Manual state transition, show UI
                    document.body.removeAttribute('hidden');
                }
                return true;
            }

            function addHidden(form, key, value) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            function getHashParams() {
                var hashParams = {};
                var e,
                    a = /\+/g,  // Regex for replacing addition symbol with a space
                    r = /([^&;=]+)=?([^&;]*)/g,
                    d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
                    q = window.location.hash.substring(1);

                while (e = r.exec(q))
                   hashParams[d(e[1])] = d(e[2]);

                return hashParams;
            }
        }
    </script>
</body>
</html>