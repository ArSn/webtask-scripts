<html>
<head>
    <title>Login Workflow</title>
    <style>
        body { 
            background: #EB5424;
        }
        pre {
            word-wrap: break-word;
            padding: 2em;
        }
    </style>
    <script type="text/javascript" src="/webtask-scripts/scripts/webtask-wf.js"></script>
</head>
<body hidden>
    <h1>Web Task Samples: Login Workflow</h1>
    <p>Executing 3 step login workflow using web tasks:</p>
    <il>
        <li>[app] Start workflow from originating app (i.e. this app)</a>
        <li>[webtasks] Login with Google</li>
        <li>[webtasks] Then login with Microsoft</li>
        <li>[webtasks] Then accept privacy policy</li>
        <li>[app] Then return to originating app (i.e. this app) to process results of workflow execution</li>
    </il>
    <p><strong>NOTE</strong> originating app has orange background, webtask workflow has blue background.<p>

    <div id="results_container" hidden>
        <h1>Workflow has completed, workflow results are below</h1>
        <p>At this point the SPA application would do something useful with these results.</p>
        <pre id="results"></pre>
    </div>

    <!-- The form is required for the webtask engine to orchestrate state transitions 
         TODO (tjanczuk): consider creating a transient one by default -->
    <form id="auth0-wf" method="POST">
        <input type="submit" value="Start login workflow"/>
    </form>

    <script>
        // Webtask Workflow is a state machine. Each state describes:
        // * url - (required) the webtask to run in that state
        // * inputs - (optional) client-side data to pass to the webtask
        // * next - (optional) a string describing the next state to transition to after the 
        //   webtask is done, or a function that returns the next state to transition to
        // * transition - (optional) 'manual' or 'auto' (default); whether the invocation of 
        //   the next webtask state is done automatically or requires app/user initiatied 
        //   action (e.g. click of a form submit or programmatic submit)
        // The `start` state is the default initial state unless overriden in a call to 
        // resume_workflow. The `end` state is the final state.
        // Other state names are application specific. 
        var workflow = {
            google: {

                // Login with Google

                url: 'https://sandbox.it.auth0.com/auth0-wf?webtask_no_cache=1&key=eyJhbGciOiJIUzI1NiIsImtpZCI6IjEifQ.eyJqdGkiOiI5YjFjMGNlNjgyZTQ0NzlhODY1ZTE2Y2JlYjdjNzVmZiIsImlhdCI6MTQyNTY3Nzc4MywidXJsIjoiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2F1dGgwL3dlYnRhc2stc2NyaXB0cy9tYXN0ZXIvbG9naW4vYXV0aDBfbG9naW4uanMiLCJ0ZW4iOiJhdXRoMC13ZiIsInBjdHgiOnsiYXV0aDBfZG9tYWluIjoiYXV0aDAtd2YuYXV0aDAuY29tIiwiYXV0aDBfY2xpZW50X2lkIjoiZ2RVOG50NVFiZE1BcGM4N2VkN2UxQlRlWTQ2TzdDemMifX0.MvwWuM__Y_z8WRUL4QnSA9foxL__eq2l6Q3ywcwzkmw',
                inputs: {
                    strategy: 'google-oauth2',
                    title: 'Please authenticate with Google first'
                },
                transition: 'manual',
                next: 'microsoft'
            },
            microsoft: {

                // Login with Microsoft

                url: 'https://sandbox.it.auth0.com/auth0-wf?webtask_no_cache=1&key=eyJhbGciOiJIUzI1NiIsImtpZCI6IjEifQ.eyJqdGkiOiI5YjFjMGNlNjgyZTQ0NzlhODY1ZTE2Y2JlYjdjNzVmZiIsImlhdCI6MTQyNTY3Nzc4MywidXJsIjoiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2F1dGgwL3dlYnRhc2stc2NyaXB0cy9tYXN0ZXIvbG9naW4vYXV0aDBfbG9naW4uanMiLCJ0ZW4iOiJhdXRoMC13ZiIsInBjdHgiOnsiYXV0aDBfZG9tYWluIjoiYXV0aDAtd2YuYXV0aDAuY29tIiwiYXV0aDBfY2xpZW50X2lkIjoiZ2RVOG50NVFiZE1BcGM4N2VkN2UxQlRlWTQ2TzdDemMifX0.MvwWuM__Y_z8WRUL4QnSA9foxL__eq2l6Q3ywcwzkmw',
                inputs: {
                    strategy: 'windowslive',
                    title: 'Now authenticate with Microsoft Account'
                },
                next: 'bendy_banana'
            },
            bendy_banana: {

                // Require acceptance of bendy banana law

                url: 'https://sandbox.it.auth0.com/auth0-wf?webtask_no_cache=1&key=eyJhbGciOiJIUzI1NiIsImtpZCI6IjEifQ.eyJqdGkiOiI4MmY1YzEyNjA3YTE0YTEyYTUzNjFmMGFhZDliNGE0ZiIsImlhdCI6MTQyNTY5MjcxNCwidXJsIjoiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2F1dGgwL3dlYnRhc2stc2NyaXB0cy9tYXN0ZXIvbG9naW4vYmVuZHlfYmFuYW5hLmpzIiwidGVuIjoiYXV0aDAtd2YiLCJwY3R4Ijp7ImF1dGgwX2RvbWFpbiI6ImF1dGgwLXdmLmF1dGgwLmNvbSIsImF1dGgwX2NsaWVudF9pZCI6ImdkVThudDVRYmRNQXBjODdlZDdlMUJUZVk0Nk83Q3pjIn19.bC9VOhFgCGOVBwOzX47nyA3deIV9DrQUqJC4Fvh1Www'
            }
        }

        // Resume workflow 
        if (!resume_workflow(workflow, { intitial_state: 'google' })) {
            // Workflow completed, do something smart with the results
            var results = get_workflow_state();

            document.getElementById('results').innerHTML = JSON.stringify(results, null, 2);
            document.getElementById('results_container').removeAttribute('hidden');
            document.forms['auth0-wf'].style.display = 'none';
        }

    </script>
</body>
</html>